{% extends "base.html" %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div>
        <span class="eyebrow">Doctor Panel</span>
        <h2 class="mb-0">Appointment Requests</h2>
    </div>
</div>

<div class="row g-2 mb-3">
    <div class="col-md-3">
        <div class="ui-card p-3"><div class="small text-muted">Today ({{ today }})</div><div class="h4 mb-0">{{ summary.today_total }}</div></div>
    </div>
    <div class="col-md-3">
        <div class="ui-card p-3"><div class="small text-muted">Pending</div><div class="h4 mb-0">{{ summary.today_pending }}</div></div>
    </div>
    <div class="col-md-3">
        <div class="ui-card p-3"><div class="small text-muted">Approved</div><div class="h4 mb-0">{{ summary.today_approved }}</div></div>
    </div>
    <div class="col-md-3">
        <div class="ui-card p-3"><div class="small text-muted">Rejected</div><div class="h4 mb-0">{{ summary.today_rejected }}</div></div>
    </div>
</div>

<form method="get" class="ui-card p-3 mb-3">
    <div class="row g-2">
        <div class="col-md-4">
            <input type="text" name="q" value="{{ query }}" class="form-control" placeholder="Search patient or note">
        </div>
        <div class="col-md-3">
            <input type="date" name="date" value="{{ date_filter }}" class="form-control">
        </div>
        <div class="col-md-3">
            <select name="status" class="form-select">
                <option value="">All statuses</option>
                <option value="pending" {% if status_filter == "pending" %}selected{% endif %}>Pending</option>
                <option value="approved" {% if status_filter == "approved" %}selected{% endif %}>Approved</option>
                <option value="rejected" {% if status_filter == "rejected" %}selected{% endif %}>Rejected</option>
            </select>
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-brand">Apply</button>
        </div>
    </div>
</form>

<div class="d-flex gap-2 flex-wrap mb-3">
    <button type="button" class="interactive-chip active" data-live-status="all">All</button>
    <button type="button" class="interactive-chip" data-live-status="pending">Pending</button>
    <button type="button" class="interactive-chip" data-live-status="approved">Approved</button>
    <button type="button" class="interactive-chip" data-live-status="rejected">Rejected</button>
</div>

<div class="d-none d-md-block ui-card table-card">
<table class="table table-hover align-middle mb-0">
    <thead>
        <tr>
            <th>Patient</th>
            <th>Date</th>
            <th>Time</th>
            <th>Description</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
        {% for appt in appointments %}
        <tr data-status="{{ appt.status }}">
            <td>{{ appt.patient.username }}</td>
            <td>{{ appt.date }}</td>
            <td>{{ appt.time }}</td>
            <td>{{ appt.description }}</td>
            <td>
                {% if appt.status == "pending" %}
                    <span class="badge-status status-pending">Pending</span>
                {% elif appt.status == "approved" %}
                    <span class="badge-status status-approved">Approved</span>
                {% else %}
                    <span class="badge-status status-rejected">Rejected</span>
                {% endif %}
            </td>
            <td>
                {% if appt.status == "pending" %}
                    <form method="post" action="{% url 'approve_appointment' appt.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success btn-sm">Approve</button>
                    </form>
                    <form method="post" action="{% url 'reject_appointment' appt.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                    </form>
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center muted-note py-4">No appointments</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<div class="d-md-none">
    {% for appt in appointments %}
    <div class="ui-card p-3 mb-2" data-status="{{ appt.status }}">
        <div class="d-flex justify-content-between align-items-center">
            <strong>{{ appt.patient.username }}</strong>
            {% if appt.status == "pending" %}
                <span class="badge-status status-pending">Pending</span>
            {% elif appt.status == "approved" %}
                <span class="badge-status status-approved">Approved</span>
            {% else %}
                <span class="badge-status status-rejected">Rejected</span>
            {% endif %}
        </div>
        <div class="small text-muted mt-2">{{ appt.date }} at {{ appt.time }}</div>
        <div class="mt-2 mb-2">{{ appt.description|default:"No description" }}</div>
        {% if appt.status == "pending" %}
        <div class="d-flex gap-2">
            <form method="post" action="{% url 'approve_appointment' appt.id %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-success btn-sm">Approve</button>
            </form>
            <form method="post" action="{% url 'reject_appointment' appt.id %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm">Reject</button>
            </form>
        </div>
        {% endif %}
    </div>
    {% empty %}
    <div class="ui-card p-3 muted-note">No appointments.</div>
    {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const chips = document.querySelectorAll("[data-live-status]");
  const rows = document.querySelectorAll("tr[data-status], div[data-status]");
  chips.forEach(chip => {
    chip.addEventListener("click", function () {
      chips.forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      const status = chip.getAttribute("data-live-status");
      rows.forEach(row => {
        const visible = status === "all" || row.getAttribute("data-status") === status;
        row.style.display = visible ? "" : "none";
      });
    });
  });
});
</script>
{% endblock %}
